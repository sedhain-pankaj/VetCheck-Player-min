<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Vetcheck Playlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Vetcheck PLaylist">
    <meta property="og:title" content="Vetcheck Playlist">
    <meta name="author" content="sedhain_pankaj">
    <meta name="owner" content="sedhain.pankaj@gmail.com">
    <meta name="og:country-name" content="Australia">

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- local js -->
    <script src="/index.js" type="text/javascript"></script>
    <script src="/shuffle.js" type="text/javascript"></script>

    <!-- mediaelement JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/7.0.3/mediaelement-and-player.min.js"
        integrity="sha512-EnXqn36fJGqZrm7gIiaSldbvpSYtjTVqG4n7HEcto6GNhjQqGpvaG0IAdmh+r6qhqgMFCXQK+v9k5PHx+JPRyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/7.0.3/mediaelementplayer.min.css"
        integrity="sha512-7D82/+kVzJhvYhr5k2+TueNVDAoZA4MAklU9vjupYEAnLx97qV3UFZQZgwaD6dPSAEEIiQXBDkK0Wh5BMTUFBA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            width: 100vw;
            height: 100vh;
        }

        #video_container {
            position: absolute;
            overflow: hidden;
            margin: 0;
            inset: 0;
        }

        video {
            width: 100%;
            height: 100%;
        }
    </style>

</head>

<body>

    <div id="video_container">
        <video id="video" src="" autoplay preload="auto"></video>
    </div>

</body>

</html>

<script>
    //variables to cache the song categories data
    var cache = null;
    //array to hold the shuffled songs
    let shuffleArrays = { shuffle_category: [] };

    // Fetches the data and stores it in the cache
    function fetchData() {
        return $.getJSON([
            {
                "VideoID": "ujhEEh-G0GM",
                "Thumbnail": "https://i.ytimg.com/vi/ujhEEh-G0GM/default.jpg",
                "Title": "VetCheck overview"
            },
            {
                "VideoID": "p0Yrvj1buag",
                "Thumbnail": "https://i.ytimg.com/vi/p0Yrvj1buag/default.jpg",
                "Title": "VetCheck Demo - Enhance Client Communications"
            },
            {
                "VideoID": "i2_PG6XNKWE",
                "Thumbnail": "https://i.ytimg.com/vi/i2_PG6XNKWE/default.jpg",
                "Title": "VetCheck Overview for Client Education"
            },
            {
                "VideoID": "oHShrag6Wt0",
                "Thumbnail": "https://i.ytimg.com/vi/oHShrag6Wt0/default.jpg",
                "Title": "VetCheck-RxWorks Integration"
            },
            {
                "VideoID": "TFL7KCLDgaM",
                "Thumbnail": "https://i.ytimg.com/vi/TFL7KCLDgaM/default.jpg",
                "Title": "VetCheck Training - How to use the hospital chart & digital whiteboard"
            },
            {
                "VideoID": "2TYtHwyLVzA",
                "Thumbnail": "https://i.ytimg.com/vi/2TYtHwyLVzA/default.jpg",
                "Title": "Digital veterinary hospital whiteboard chart and workflow"
            },
            {
                "VideoID": "crG0uYJ3r48",
                "Thumbnail": "https://i.ytimg.com/vi/crG0uYJ3r48/default.jpg",
                "Title": "VetCheck Automate Overview"
            },
            {
                "VideoID": "FMEZP-OnBnY",
                "Thumbnail": "https://i.ytimg.com/vi/FMEZP-OnBnY/default.jpg",
                "Title": "Increase practice efficiency with VetCheck forms"
            },
            {
                "VideoID": "v6dhxTZ9lmA",
                "Thumbnail": "https://i.ytimg.com/vi/v6dhxTZ9lmA/default.jpg",
                "Title": "VetCheck Petbooqz Integration"
            },
            {
                "VideoID": "zhoJCmD3ZK8",
                "Thumbnail": "https://i.ytimg.com/vi/zhoJCmD3ZK8/default.jpg",
                "Title": "VetCheck - How to SHARE a form or online health assessment"
            },
            {
                "VideoID": "gPyLtDfZ6ZA",
                "Thumbnail": "https://i.ytimg.com/vi/gPyLtDfZ6ZA/default.jpg",
                "Title": "VetCheck - How to SHARE a handout to one or more clients"
            }
        ]
        ).then(function (data) {
            //json has a list of songs dictionary with fields: VideoID, Thumbnail and Title
            cache = { response: data };
        });
    }

    //logic for ajax call to get the shuffled songs from their JSON
    function shuffleAjaxCall() {
        var dataPromise;

        if (!cache) {
            dataPromise = fetchData();
        } else {
            // If the cache is not empty, use a resolved promise
            dataPromise = $.Deferred().resolve().promise();
        }

        dataPromise.then(function () {
            shuffleArrays["shuffle_category"] = cache.response.map(
                (song) => `https://www.youtube.com/embed/${song.VideoID}`
            );

            shuffleArrays["shuffle_category"].sort(function () {
                return 0.5 - Math.random();
            });

            shuffler(shuffleArrays["shuffle_category"]);
        });
    }

    function shuffler(array) {
        if (array.length == 0) {
            // Refresh #video
            $("#video_container").empty();
            // Create a new media element in the video container
            $("#video_container").html(
                "<video id='video' src='' autoplay preload='auto'></video>"
            );

            // Video dimensions scale to fit the container
            video_scaler();

            //a random click on DOM element to trigger autoshuffle => checkActivity()
            //re-triggers shuffle when previous shuffle ends
            $("#queue_header").click();
            return;
        }

        //if queue_array is not empty, play_Queue()
        function relooper_shuffle() {
            shuffler(array);
        }

        //get the video element and set the source for mejs player
        var video = document.getElementById("video");
        video.src = array[0];
        mejs_media_Player(relooper_shuffle);

        //remove first element from array after playing
        array.shift();
    }

    //show or hide different search options
    $(document).ready(function () {
        fetchData();
        video_scaler();
        autoShuffle();
    });

    //function to scale down video to fit within video_container and pointer events to auto
    function video_scaler() {
        $("video").css("width", $("#video_container").width());
        $("video").css("height", $("#video_container").height());
        $("video").attr("width", $("video").width());
        $("video").attr("height", $("video").height());
    }

    //run the shuffle function if no songs are playing
    function autoShuffle() {
        var timeout = false;
        function checkActivity() {
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                if ($("video").attr("src") == "") {
                    shuffleAjaxCall();
                }
            }, 1);
        }
        document.addEventListener("mousedown", checkActivity);
        document.addEventListener("mousemove", checkActivity);
        document.addEventListener("click", checkActivity);
        checkActivity();
    }

    //mejs player
    function mejs_media_Player(func_restarter) {
        $("video").mediaelementplayer({
            iconSprite: "/mejs.svg",
            clickToPlayPause: true,
            features: ["playpause", "progress", "current", "duration", "fullscreen"],
            enableKeyboard: true,
            useFakeFullscreen: true,
            enableAutosize: true,

            success: function (mediaElement, DOMObject, player) {
                mediaElement.addEventListener("ended", function (e) {
                    func_restarter();
                });
            },

            error: function (e) {
                console.log("media element error:" + e);
                $("#video_container").empty();
                //create a new media element in the video container
                $("#video_container").html(
                    "<video id='video' src='' autoplay preload='auto'></video>"
                );
                video_scaler();
                func_restarter();
            },
        });
    }

</script>